@page "/admin/products"
@using courseApi.Models
@inject courseProd.Services.ApiClient Api
@inject courseProd.Services.ToastService Toast

<h3>Управление товарами</h3>
<div style="margin-bottom:12px;">
    <button class="btn" @onclick="Load">Обновить</button>
    <a class="btn" href="/admin">Назад</a>
</div>

@if (products == null)
{
    <p>Загрузка...</p>
}
else if (products.Length == 0)
{
    <p>Товаров нет.</p>
}
else
{
    <table class="table" style="background:var(--card-bg); border-radius:8px; box-shadow:0 6px 20px rgba(11,11,35,0.04); overflow:hidden;">
        <thead>
            <tr>
                <th>Id</th>
                <th>Sku</th>
                <th>Название</th>
                <th>Цена</th>
                <th>Категория</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var p in products)
            {
                <tr>
                    <td>@p.Id</td>
                    <td>@p.Sku</td>
                    <td>@p.Name</td>
                    <td>@p.Price.ToString("N2")</td>
                    <td>@p.CategoryId</td>
                    <td>
                        <button @onclick="() => Edit(p)">Ред.</button>
                        <button class="btn-danger" @onclick="() => Delete(p.Id)">Удалить</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

<div style="margin-top:18px; border-top:1px solid #eee; padding-top:12px;">
    <h4>@(editing ? "Редактировать товар" : "Добавить товар")</h4>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; max-width:800px;">
        <input placeholder="Sku" @bind="form.Sku" />
        <input placeholder="Название" @bind="form.Name" />
        <input placeholder="Цена" @bind="form.Price" />
        <input placeholder="Stock" @bind="form.Stock" />
        <input placeholder="CategoryId" @bind="form.CategoryId" />
        <input placeholder="Описание" @bind="form.Description" />
    </div>
    <div style="margin-top:8px;">
        <button class="btn" @onclick="Save">Сохранить</button>
        <button class="btn" @onclick="ClearForm">Отмена</button>
    </div>
</div>

@code {
    Product[]? products = null;
    bool editing = false;
    ProductForm form = new();

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    async Task Load()
    {
        try
        {
            products = await Api.GetJson<Product[]>("api/admin/products");
            if (products == null) products = Array.Empty<Product>();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Ошибка загрузки продуктов: " + ex.Message);
            await Toast.ShowAsync("Ошибка при загрузке данных", "error");
        }
    }

    void Edit(Product p)
    {
        editing = true;
        form.Id = p.Id;
        form.Sku = p.Sku;
        form.Name = p.Name;
        form.Price = p.Price.ToString();
        form.Stock = p.Stock.ToString();
        form.CategoryId = p.CategoryId?.ToString() ?? string.Empty;
        form.Description = p.Description;
    }

    void ClearForm()
    {
        editing = false;
        form = new ProductForm();
    }

    async Task Save()
    {
        var payload = new
        {
            Sku = form.Sku,
            Name = form.Name,
            Description = form.Description,
            Price = decimal.TryParse(form.Price, out var price) ? price : 0m,
            Stock = int.TryParse(form.Stock, out var stock) ? stock : 0,
            CategoryId = int.TryParse(form.CategoryId, out var catId) ? (int?)catId : null
        };

        if (editing)
        {
            var ok = await Api.PutJson($"api/admin/products/{form.Id}", payload);
            if (ok)
                await Toast.ShowAsync("Изменено", "success");
            else
                await Toast.ShowAsync("Ошибка при обновлении", "error");
        }
        else
        {
            var (ok, data, text, status) = await Api.PostJson("api/admin/products", payload);
            if (ok)
                await Toast.ShowAsync("Добавлено", "success");
            else
                await Toast.ShowAsync(!string.IsNullOrEmpty(text) ? $"Ошибка: {text}" : $"Ошибка (код {status})", "error");
        }

        ClearForm();
        await Load();
    }


    async Task Delete(int id)
    {
        var ok = await Api.DeleteAsync($"api/admin/products/{id}");
        if (ok)
            await Toast.ShowAsync("Удалено", "success");
        else
            await Toast.ShowAsync("Ошибка", "error");

        await Load();
    }

    class ProductForm
    {
        public int Id { get; set; }
        public string Sku { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string Price { get; set; } = "0";
        public string Stock { get; set; } = "0";
        public string CategoryId { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
    }
}
